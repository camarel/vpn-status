<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VPN Status</title>
</head>
<body>
  <style>
    body {
      background: #193549;
      color: white;
      font-family: 'helvetica neue', sans-serif;
      font-weight: 100;
      margin: 0 1em;
    }

    h1 {
      text-align: center;
      font-size: 250%;
    }

    p {
      font-size: 110%;
    }

    p:before {
      content: ' ';
      display: inline-block;
      width: 1em;
    }

    p.ok:before {
      color: #75ba6b;
      content: '\2713';
    }

    p.error:before,
    p.timeout:before {
      color: #ba6b6b;
      content: '\2717';
    }

    iframe {
      width: 100%;
      border: 0;
    }
  </style>

  <h1>VPN Status</h1>

  <div id="vpnstatus"></div>

  <iframe id="traceroute" src="" height="300">
  </iframe>

<script>

/**********************************
 * Configuration:
 *
 * vpnServer: ip address of the VPN server
 * traceHost: hostname for traceroute
 *
 **********************************/

const vpnServer = '192.168.200.1';
const traceHost = 'openwrt.org';

/**********************************/


document.getElementById('traceroute').src = `/cgi-bin/vpnstatus?trace=${traceHost}`;

function ping(ip, callback) {
  const obj = {};
  obj.el = document.createElement('p');
  obj.ms = '';
  obj.el.innerHTML = `${ip}: `;
  document.getElementById('vpnstatus').appendChild(obj.el);

  fetch(`/cgi-bin/vpnstatus?ping=${ip}`)
    .then((response) => {
      if (response.ok) {
        return response.text();
      }
    })
    .then(function(data) {
      // request was successful
      if (data) {
        // ping was successful
        if (data.includes('time')) {
          obj.ms = data.replace(/.*time=/, '')
          callback('ok', obj, data);
        // ping was not successful
        } else {
          callback('timeout', obj);
        }
      // error on request
      } else {
        callback('error', obj);
      }
    })
    .catch(function(error) {
      callback('error', obj);
    });
}

updateResult = function(status, data) {
  data.el.innerHTML = `${data.el.innerHTML} ${status} ${data.ms}`;
  data.el.classList.add(status);
}

new ping(vpnServer, updateResult);

// more hosts to ping can be defined as follows:
// new ping('192.168.2.1', updateResult);

</script>


</body>
</html>
