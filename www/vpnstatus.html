<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VPN Status</title>
</head>
<body>
  <style>
    body {
      background: #193549;
      color: white;
      font-family: 'helvetica neue', sans-serif;
      font-weight: 100;
      margin: 0 1em;
    }

    h1 {
      text-align: center;
      font-size: 250%;
    }

    .status {
      font-size: 110%;
    }

    iframe {
      width: 100%;
      border: 0;
    }

    .status:before {
      content: ' ';
      display: inline-block;
      width: 1em;
    }

    .status.ok:before {
      color: #75ba6b;
      content: '\2713';
    }

    .status.error:before,
    .status.timeout:before {
      color: #ba6b6b;
      content: '\2717';
    }
  </style>

  <h1>VPN Status</h1>

  <div id="vpnstatus"></div>

  <p class="status" id="traceStatus">Traceroute</p>

  <iframe id="traceroute" src="" height="300">
  </iframe>

<script>

/**********************************
 * Configuration:
 *
 * pingHosts: list of ip addresses to ping
 * traceHost: hostname for traceroute
 * traceMatch: a pattern to match traceroute, ip or host
 *
 **********************************/

const pingHosts = [
  '192.168.200.1',
  // more hosts to ping can be defined as follows:
  // '192.168.2.1',
];

const traceHost = 'wikipedia.org';
const traceMatch = 'gateway.orange.com';

/**********************************/

const getFrameDocument = (frame) => {
  return frame.contentWindow
    ? frame.contentWindow.document
    : frame.contentDocument;
};

const iframe = document.getElementById('traceroute');
iframe.src = `/cgi-bin/vpnstatus?trace=${traceHost}`;

iframe.onload = () => {
  const frameDocument = getFrameDocument(iframe);
  const response = frameDocument.getElementById('traceResponse');
  const traceStatus = document.getElementById('traceStatus');

  if (response && response.innerHTML.includes(traceMatch)) {
    traceStatus.classList.add('ok');
  } else {
    traceStatus.classList.add('error');
  }
};

const ping = (ip, callback) => {
  const obj = {};
  obj.el = document.createElement('p');
  obj.el.classList.add('status');
  obj.ms = '';
  obj.el.innerHTML = `${ip}: `;
  document.getElementById('vpnstatus').appendChild(obj.el);

  fetch(`/cgi-bin/vpnstatus?ping=${ip}`)
    .then((response) => {
      if (response.ok) {
        return response.text();
      }

      return null;
    })
    .then((data) => {
      // request was successful
      if (data) {
        // ping was successful
        if (data.includes('time')) {
          obj.ms = data.replace(/.*time=/, '');
          callback('ok', obj, data);
        // ping was not successful
        } else {
          callback('timeout', obj);
        }
      // error on request
      } else {
        callback('error', obj);
      }
    })
    .catch((error) => {
      callback('error', obj);
    });
};

const updateResult = (status, data) => {
  data.el.innerHTML = `${data.el.innerHTML} ${status} ${data.ms}`;
  data.el.classList.add(status);
};

// init ping hosts
pingHosts.forEach((host) => {
  ping(host, updateResult);
});

</script>

</body>
</html>
